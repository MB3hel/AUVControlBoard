<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://mb3hel.github.io/AUVControlBoard/firmware/build/" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Build and Flash - AUV Control Board</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Build and Flash";
        var mkdocs_page_input_path = "firmware/build.md";
        var mkdocs_page_url = "/AUVControlBoard/firmware/build/";
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> AUV Control Board
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">User Guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../user_guide/preparing_board/">Preparing a Control Board</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user_guide/general_use/">Using Control board</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user_guide/simulator/">Using the Simulator</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user_guide/comm_protocol/">Communication Protocol</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../user_guide/messages/">Messages</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Hardware</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../hardware/v1/">Version 1</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../hardware/v2/">Version 2</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../hardware/sensors/">Off-Board Sensors</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Developers</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../overview/">Overview</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="./">Build and Flash</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#building">Building</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flashing">Flashing</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#flashing-remotely">Flashing Remotely</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../math/">Math</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../math_old/">Math (Old)</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../developing/">Firmware Development</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../simhijack/">Simulation Support</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">AUV Control Board</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Developers &raquo;</li>
      <li>Build and Flash</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/MB3hel/AUVControlBoard/blob/main/docs/docs/firmware/build.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="build-and-flash">Build and Flash</h1>
<p><em>Note: Run all commands shown in the <code>firmware</code> folder of the repo.</em></p>
<h2 id="building">Building</h2>
<p>Install the Required Tools:</p>
<ul>
<li><a href="https://cmake.org/">CMake</a> (version <code>3.20.0</code> or newer)</li>
<li><a href="https://ninja-build.org/">Ninja</a></li>
<li><a href="https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads">GNU Arm Toolchain</a></li>
</ul>
<p><em>Make sure <code>cmake</code>, <code>ninja</code>, and <code>arm-none-eabi-gcc</code> are in your <code>PATH</code>.</em></p>
<p>Build the firmware using the commands below. Replace <code>[preset]</code> with <code>v1</code> or <code>v2</code>. Replace <code>[config]</code> with <code>debug</code>, <code>release</code>, <code>minsizerel</code>, or <code>relwithdebinfo</code>.</p>
<pre><code class="language-sh">cmake --preset=[preset]
cmake --build --preset=[preset]-[config]
</code></pre>
<h2 id="flashing">Flashing</h2>
<table>
<thead>
<tr>
<th>Version</th>
<th>Flash Method</th>
<th>Tool Alias</th>
<th>Required software</th>
</tr>
</thead>
<tbody>
<tr>
<td>v1</td>
<td>sam-ba (via bootloader)</td>
<td><code>bossa</code></td>
<td><a href="http://www.shumatech.com/web/products/bossa">BOSSA</a> (specifically bossac / bossa-cli)</td>
</tr>
<tr>
<td>v1</td>
<td>uf2conv (via bootloader)</td>
<td><code>uf2conv</code></td>
<td>None</td>
</tr>
<tr>
<td>v2</td>
<td>dfu-util (via bootloader)</td>
<td><code>dfu-util</code></td>
<td><a href="https://dfu-util.sourceforge.net/">dfu-util</a></td>
</tr>
<tr>
<td>v2</td>
<td>STM32CubeProgrammer DFU (via bootloader)</td>
<td><code>stm32-dfu</code></td>
<td><a href="https://www.st.com/en/development-tools/stm32cubeprog.html">STM32CubeProgrammer</a></td>
</tr>
<tr>
<td>v2</td>
<td>STM32CubeProgrammer ST-LINK v2</td>
<td><code>stm32-stlink2</code></td>
<td><a href="https://www.st.com/en/development-tools/stm32cubeprog.html">STM32CubeProgrammer</a></td>
</tr>
</tbody>
</table>
<p><em>Note: required tool (<code>bossac</code>, <code>dfu-util</code>, <code>STM32_Programmer_CLI</code>) must be in your <code>PATH</code>.</em></p>
<p>Before flashing, the chip needs to enter its bootloader (unless using a debug probe such as the stlink2 to flash)</p>
<ul>
<li>
<p><em>If a board is already flashed, it can be rebooted into its bootloader using the <code>reboot_bootloader.py</code> script in the <code>firmware</code> directory. Otherwise, use the hardware method described below.</em></p>
</li>
<li>
<p><em><strong>v1:</strong> Press the reset button twice quickly (double press).</em></p>
</li>
<li>
<p><em><strong>v2:</strong> Hold the BOOT button. While holding it, press and release the NRST button. Then release the boot button.</em></p>
</li>
</ul>
<p><em>Note: Sometimes reboot to bootloader mode "fails". On v1, this usually means it fails to attach USB (LED remains red not green.) On v2 this usually means it doesn't show up as a USB device. In either case, just try to enter again using the same button combination above.</em></p>
<p>To flash, run the <code>flash.py</code> script. It is a wrapper that will call one of the above tools</p>
<pre><code class="language-sh">python3 flash.py [version] [config] -u [tool]
</code></pre>
<ul>
<li><code>[version]</code> is either <code>v1</code> or <code>v2</code></li>
<li><code>[config]</code> is the configuration you want to flash (same as configuration built: <code>Debug</code>, <code>Release</code>, <code>MinSizeRel</code>, or <code>RelWithDebInfo</code>)</li>
<li><code>[tool]</code> is one of the above upload tool aliases.</li>
</ul>
<h2 id="flashing-remotely">Flashing Remotely</h2>
<p>Sometimes, it is useful to flash firmware without connecting directly to the control board. Typically, this is done in-system where the embedded computer using the control board (Jetson, Raspberry Pi, etc) is used to flash the control board without gaining physical access to the control board. Instead an ssh connection to the remote computer is used.</p>
<p>There are a few requirements to be able to flash remotely</p>
<ul>
<li>The control board must already be running some version of the firmware. This is necessary to be able to enter bootloader mode without access to the buttons on the board.</li>
<li>The remote computer must have a flash tool installed. For v1 this should be <code>bossac</code> and for v2 this should be <code>dfu-util</code>. These are available as packages for most Linux distributions (<code>bossa-cli</code> and <code>dfu-util</code> respectively for Debian and Ubuntu based systems).</li>
<li>You must have ssh (and by extension scp) access to the remote system (typically via ethernet tether)</li>
</ul>
<p>On the build computer (laptop, etc) build the firmware as described above. Then, login to the remote system via ssh and create a directory to hold control board flash stuff (name can be changed as desired)</p>
<pre><code class="language-sh"># Run on remote computer (via ssh)
cd ~
mkdir cboard-flash
</code></pre>
<p>Then on the build computer, use scp to copy the <code>flash.py</code> and <code>reboot_bootloader.py</code> scripts to this folder</p>
<pre><code class="language-sh"># Run on build laptop
scp firmware/flash.py user@remote_ip:cboard-flash/
scp firmware/reboot_bootloader.py user@remote_ip:cboard-flash/
</code></pre>
<p>Next copy the <code>build</code> folder. You can just copy the binaries themselves, but the folder hierarchy must be maintained.</p>
<pre><code class="language-sh"># Run on remote computer (via ssh)
# Delete old build folder first
rm -r ~/cboard-flash/build

# Run on build laptop
scp -r firmware/build user@remote_ip:cboard-flash/
</code></pre>
<p>Finally, reboot the control board to bootloader and flash</p>
<pre><code class="language-sh"># Run on remote computer (via ssh)
./reboot_bootloader.py [port]
./flash.py [version] [config] -p [port]
</code></pre>
<p><em>Note: Sometimes reboot to bootloader mode "fails". On v1, this usually means it fails to attach USB (LED remains red not green.) On v2 this usually means it doesn't show up as a USB device. In either case, you will loose USB communication to the board. In this case, a power cycle is required to "fix" the board before trying to enter the bootloader again. While inconvenient, it is still usually easier to power cycle the vehicle than to unseal it.</em></p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../overview/" class="btn btn-neutral float-left" title="Overview"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../math/" class="btn btn-neutral float-right" title="Math">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/MB3hel/AUVControlBoard" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../overview/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../math/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../js/mathjax.js" defer></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
